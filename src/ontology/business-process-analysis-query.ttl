@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix v-s: <http://semantic-machines.com/veda/veda-schema/> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix v-ui: <http://semantic-machines.com/veda/veda-ui/> .
@prefix v-bpa: <http://semantic-machines.com/veda/veda-business-process/> .

# Онтология для анализа бизнес-процессов. Запросы
v-bpa:BusinessProcessAnalysisQuery
  rdf:type owl:Ontology ;
  rdfs:label "Онтология анализа бизнес-процессов. Запросы"@ru ;
  rdfs:label "Business Process Analysis Ontology. Queries"@en ;
  v-s:loadPriority 6 ;
.

v-bpa:AllBusinessProcesses
  rdf:type v-s:StoredQuery ;
  rdfs:label "Запрос: Все бизнес-процессы"@ru ;
  rdfs:label "Query: All business processes"@en ;
  v-s:source "clickhouse" ;
  v-s:resultFormat "rows" ;
  v-s:authorizationLevel "query" ;
  v-s:queryString """
    SELECT
      id,
      arrayFirst(x -> x is NOT null,  arrayMap(x -> if(match(x, '(?i)@ru$') OR NOT match(x, '(?i)@[a-z][a-z]$'), replaceRegexpOne(x, '(?i)@[a-z][a-z]$', ''), null), rdfs_label_str)) as "rdfs:label",
      arrayFirst(x -> x is NOT null,  arrayMap(x -> if(match(x, '(?i)@ru$') OR NOT match(x, '(?i)@[a-z][a-z]$'), replaceRegexpOne(x, '(?i)@[a-z][a-z]$', ''), null), v_bpa_processDescription_str)) as "v-bpa:processDescription",
      v_bpa_processRelevance_str[1] as "v-bpa:processRelevance",
      arrayFirst(x -> x is NOT null,  arrayMap(x -> if(match(x, '(?i)@ru$') OR NOT match(x, '(?i)@[a-z][a-z]$'), replaceRegexpOne(x, '(?i)@[a-z][a-z]$', ''), null), v_bpa_responsibleDepartment_str)) as "v-bpa:responsibleDepartment",
      arrayFirst(x -> x is NOT null,  arrayMap(x -> if(match(x, '(?i)@ru$') OR NOT match(x, '(?i)@[a-z][a-z]$'), replaceRegexpOne(x, '(?i)@[a-z][a-z]$', ''), null), v_bpa_processParticipant_str)) as "v-bpa:processParticipant",
      v_bpa_processFrequency_int[1] * coalesce(v_bpa_laborCosts_dec[1], v_bpa_laborCosts_int[1]) as "v-bpa:totalTimeEffort"
    FROM veda_tt."v-bpa:BusinessProcess" FINAL
    ORDER BY "rdfs:label" ASC
  """ ;
.

v-bpa:OverallCounts
  rdf:type v-s:StoredQuery ;
  rdfs:label "Запрос: Общее количество"@ru ;
  rdfs:label "Query: Overall count"@en ;
  v-s:source "clickhouse" ;
  v-s:resultFormat "cols" ;
  v-s:authorizationLevel "query" ;
  v-s:queryString """
    SELECT 
      (
        SELECT 
          count(id) as count
        FROM veda_tt."v-bpa:BusinessProcess" FINAL
      ) as processes,
      (
        SELECT 
          count(id) as count
        FROM veda_tt."v-bpa:ProcessCluster" FINAL
      ) as clusters;
  """ ;
.


v-bpa:AllProcessClusters
  rdf:type v-s:StoredQuery ;
  rdfs:label "Запрос: Все кластеры бизнес-процессов"@ru ;
  rdfs:label "Query: All business process clusters"@en ;
  v-s:source "clickhouse" ;
  v-s:resultFormat "rows" ;
  v-s:authorizationLevel "query" ;
  v-s:queryString """
    SELECT 
      c.id,
      sum(p.v_bpa_processFrequency_int[1] * p.v_bpa_laborCosts_dec[1]) as total_time,
      count(p.id) as clustered
    FROM veda_tt."v-bpa:ProcessCluster" c FINAL
    ARRAY JOIN v_bpa_hasProcess_str as process_id
    LEFT JOIN veda_tt."v-bpa:BusinessProcess" p FINAL
    ON process_id = p.id
    GROUP BY c.id
""" ;
.

v-bpa:ProcessInClusters
  rdf:type v-s:StoredQuery ;
  rdfs:label "Запрос: Бизнес-процессы в кластерах"@ru ;
  rdfs:label "Query: Business processes in clusters"@en ;
  v-s:source "clickhouse" ;
  v-s:resultFormat "cols" ;
  v-s:authorizationLevel "query" ;
  v-s:queryString """
    SELECT 
      c.id as id
    FROM veda_tt."v-bpa:ProcessCluster" c FINAL
    ARRAY JOIN v_bpa_hasProcess_str as process_id
    LEFT JOIN veda_tt."v-bpa:BusinessProcess" p FINAL
    ON process_id = p.id
    WHERE process_id = '{v-bpa:hasProcess}'
""" ;
.

v-bpa:CurrentClusterizationAttempts
  rdf:type v-s:StoredQuery ;
  rdfs:label "Запрос: Текущие попытки кластеризации"@ru ;
  rdfs:label "Query: Current clusterization attempts"@en ;
  v-s:source "clickhouse" ;
  v-s:resultFormat "cols" ;
  v-s:authorizationLevel "query" ;
  v-s:queryString """
    SELECT 
      c.id as id
    FROM veda_tt."v-bpa:ClusterizationAttempt" c FINAL
""" ;
.

